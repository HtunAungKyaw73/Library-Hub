{"version":3,"sources":["../../../../lib/baserow/client.ts"],"sourcesContent":["// Baserow API Client\n\nimport {\n    BaserowListResponse,\n    BaserowBook,\n    BaserowAuthor,\n    BaserowUser,\n    BaserowBorrowedBook,\n    mapBaserowBookToBook,\n    mapBaserowBorrowedBook,\n    Book,\n    BorrowedBook,\n} from \"./types\"\n\nconst BASEROW_API_URL = process.env.NEXT_PUBLIC_BASEROW_API_URL || \"https://api.baserow.io\"\nconst BASEROW_API_TOKEN = process.env.NEXT_PUBLIC_BASEROW_API_TOKEN || \"\"\n\n// Table IDs\nconst TABLE_BOOKS = process.env.NEXT_PUBLIC_BASEROW_TABLE_BOOKS || \"772570\"\nconst TABLE_AUTHORS = process.env.NEXT_PUBLIC_BASEROW_TABLE_AUTHORS || \"772588\"\nconst TABLE_PUBLISHERS = process.env.NEXT_PUBLIC_BASEROW_TABLE_PUBLISHERS || \"772593\"\nconst TABLE_USERS = process.env.NEXT_PUBLIC_BASEROW_TABLE_USERS || \"772601\"\nconst TABLE_BORROW_BOOKS = process.env.NEXT_PUBLIC_BASEROW_TABLE_BORROW_BOOKS || \"772607\"\n\n/**\n * Base fetch function for Baserow API\n */\nasync function baserowFetch<T>(\n    endpoint: string,\n    options: RequestInit = {}\n): Promise<T> {\n    const url = `${BASEROW_API_URL}${endpoint}`\n\n    const response = await fetch(url, {\n        ...options,\n        headers: {\n            \"Authorization\": `Token ${BASEROW_API_TOKEN}`,\n            \"Content-Type\": \"application/json\",\n            ...options.headers,\n        },\n    })\n\n    if (!response.ok) {\n        const error = await response.text()\n        throw new Error(`Baserow API error: ${response.status} - ${error}`)\n    }\n\n    return response.json()\n}\n\n/**\n * Get all books with author data\n */\nexport async function getBooks(): Promise<Book[]> {\n    const response = await baserowFetch<BaserowListResponse<BaserowBook>>(\n        `/api/database/rows/table/${TABLE_BOOKS}/?user_field_names=true&size=200`,\n        {\n            next: { revalidate: 60, tags: [\"books\"] },\n        } as RequestInit\n    )\n    return response.results.map(mapBaserowBookToBook)\n}\n\n/**\n * Get a single book by ID\n */\nexport async function getBook(id: string): Promise<Book | null> {\n    try {\n        const book = await baserowFetch<BaserowBook>(\n            `/api/database/rows/table/${TABLE_BOOKS}/${id}/?user_field_names=true`\n        )\n        return mapBaserowBookToBook(book)\n    } catch {\n        return null\n    }\n}\n\n/**\n * Get all authors\n */\nexport async function getAuthors(): Promise<BaserowAuthor[]> {\n    const response = await baserowFetch<BaserowListResponse<BaserowAuthor>>(\n        `/api/database/rows/table/${TABLE_AUTHORS}/?user_field_names=true`\n    )\n    return response.results\n}\n\n/**\n * Get user by email (for login)\n */\nexport async function getUserByEmail(email: string): Promise<BaserowUser | null> {\n    try {\n        const response = await baserowFetch<BaserowListResponse<BaserowUser>>(\n            `/api/database/rows/table/${TABLE_USERS}/?user_field_names=true&filter__email__equal=${encodeURIComponent(email)}`\n        )\n        return response.results[0] || null\n    } catch {\n        return null\n    }\n}\n\n/**\n * Get user by ID\n */\nexport async function getUserById(id: string): Promise<BaserowUser | null> {\n    try {\n        const user = await baserowFetch<BaserowUser>(\n            `/api/database/rows/table/${TABLE_USERS}/${id}/?user_field_names=true`\n        )\n        return user\n    } catch {\n        return null\n    }\n}\n\n/**\n * Get borrowed books for a user\n */\nexport async function getBorrowedBooks(userId: string): Promise<BorrowedBook[]> {\n    try {\n        const response = await baserowFetch<BaserowListResponse<BaserowBorrowedBook>>(\n            `/api/database/rows/table/${TABLE_BORROW_BOOKS}/?user_field_names=true&filter__User__link_row_has=${userId}`\n        )\n        return response.results.map(mapBaserowBorrowedBook)\n    } catch {\n        return []\n    }\n}\n\n/**\n * Create a borrow record\n */\nexport async function createBorrowRecord(data: {\n    bookId: string\n    userId: string\n    dueDate: string\n}): Promise<BaserowBorrowedBook | null> {\n    try {\n        const response = await baserowFetch<BaserowBorrowedBook>(\n            `/api/database/rows/table/${TABLE_BORROW_BOOKS}/?user_field_names=true`,\n            {\n                method: \"POST\",\n                body: JSON.stringify({\n                    Book: [parseInt(data.bookId)],\n                    User: [parseInt(data.userId)],\n                    Borrowed_At: new Date().toISOString(),\n                    Due_Date: data.dueDate,\n                    Status: \"borrowed\",\n                }),\n            }\n        )\n        return response\n    } catch {\n        return null\n    }\n}\n\n/**\n * Update a borrow record (e.g., mark as returned)\n */\nexport async function updateBorrowRecord(\n    id: string,\n    data: Partial<{\n        Returned_At: string\n        Status: \"borrowed\" | \"returned\" | \"overdue\"\n    }>\n): Promise<BaserowBorrowedBook | null> {\n    try {\n        const response = await baserowFetch<BaserowBorrowedBook>(\n            `/api/database/rows/table/${TABLE_BORROW_BOOKS}/${id}/?user_field_names=true`,\n            {\n                method: \"PATCH\",\n                body: JSON.stringify(data),\n            }\n        )\n        return response\n    } catch {\n        return null\n    }\n}\n\n/**\n * Update book available copies\n */\nexport async function updateBookCopies(\n    bookId: string,\n    availableCopies: number\n): Promise<BaserowBook | null> {\n    try {\n        const response = await baserowFetch<BaserowBook>(\n            `/api/database/rows/table/${TABLE_BOOKS}/${bookId}/?user_field_names=true`,\n            {\n                method: \"PATCH\",\n                body: JSON.stringify({\n                    Available_Copies: availableCopies,\n                }),\n            }\n        )\n        return response\n    } catch {\n        return null\n    }\n}\n\n/**\n * Create a new user (for sign-up)\n */\nexport async function createUser(data: {\n    email: string\n    password: string\n    fullName?: string\n}): Promise<BaserowUser | null> {\n    try {\n        const response = await baserowFetch<BaserowUser>(\n            `/api/database/rows/table/${TABLE_USERS}/?user_field_names=true`,\n            {\n                method: \"POST\",\n                body: JSON.stringify({\n                    email: data.email,\n                    password: data.password, // Should be hashed before sending\n                    username: data.fullName || null,\n                    is_admin: false,\n                }),\n            }\n        )\n        return response\n    } catch {\n        return null\n    }\n}\n\n"],"names":[],"mappings":"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"}